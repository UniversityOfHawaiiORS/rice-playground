<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">
<beans>
    <bean class="org.springframework.beans.factory.annotation.RequiredAnnotationBeanPostProcessor"/>

    <bean name="properties" class="org.kuali.rice.core.config.spring.ConfigPropertyPlaceholderConfigurer">
        <property name="properties">
            <props>
                <prop key="kcb.url">KCBSpringBeans.xml default kcb.url</prop>
                <prop key="kcb.smtp.host">localhost</prop>
                <prop key="kcb.messaging.synchronous">false</prop>
                <prop key="kcb.messageprocessing.startDelayMS">50000</prop>
                <prop key="kcb.messageprocessing.repeatIntervalMS">30000</prop>
                <prop key="kcb.quartz.group">KCB-Delivery</prop>
                <prop key="kcb.quartz.job.name">MessageProcessingJobDetail</prop>
                <prop key="kcb.maxProcessAttempts">3</prop>
            </props>
        </property>
    </bean>

    <bean id="userTransaction" class="org.kuali.rice.core.jta.UserTransactionFactoryBean" lazy-init="true" />
    <bean id="jtaTransactionManager" class="org.kuali.rice.core.jta.TransactionManagerFactoryBean" lazy-init="true" />

    <bean id="ojbConfigurer" class="org.kuali.rice.core.ojb.JtaOjbConfigurer">
        <property name="transactionManager" ref="jtaTransactionManager" />
    </bean>

    <bean id="transactionManager" class="org.springframework.transaction.jta.JtaTransactionManager" lazy-init="true">
        <property name="userTransaction">
            <ref local="userTransaction" />
        </property>
        <property name="transactionManager">
            <ref local="jtaTransactionManager" />
        </property>
    </bean>

    <bean id="kcbDataSource" class="org.kuali.rice.core.database.PrimaryDataSourceFactoryBean">
        <property name="preferredDataSourceParams">
            <list>
                <value>org.kuali.rice.kcb.datasource</value>
            </list>
        </property>
        <property name="preferredDataSourceJndiParams">
            <list>
                <value>org.kuali.rice.kcb.datasource.jndi.location</value>
            </list>
        </property>
    </bean>


    <!-- Eagerly-init KCB initializer; sets OJB platform dynamically for now -->
    <bean id="initializer" class="org.kuali.rice.kcb.config.KCBInitializer" lazy-init="false" depends-on="ojbConfigurer">
        <property name="messageProcessingTrigger" ref="periodicMessageProcessingTrigger"/>
        <property name="messageProcessingJobDetail" ref="messageProcessingJobDetail"/>
    </bean>

    <!-- Applies a transaction template to the actual transaction manager bean -->
    <!-- This is needed to recognize services as transactions -->
    <bean id="transactionTemplate"
        class="org.springframework.transaction.support.TransactionTemplate">
        <property name="transactionManager">
            <ref bean="transactionManager" />
        </property>
    </bean>

    <!-- PROPAGATION REQUIRED TX DECLARATIONS -->
    <!-- Sets up pattern matching for transaction recognition -->
    <!-- This is needed to recognize services as transactions -->
    <bean id="matchAllWithPropReq"
        class="org.springframework.transaction.interceptor.MatchAlwaysTransactionAttributeSource">
        <property name="transactionAttribute">
            <value>PROPAGATION_REQUIRED</value>
        </property>
    </bean>

    <!-- Applys the pattern matching to the transaction manager bean -->
    <!-- This is needed to recognize servi ces as transactions -->
    <bean id="matchAllTxInterceptor"
        class="org.springframework.transaction.interceptor.TransactionInterceptor">
        <property name="transactionManager">
            <ref bean="transactionManager" />
        </property>
        <property name="transactionAttributeSource">
            <ref bean="matchAllWithPropReq" />
        </property>
    </bean>

    <!-- All of the beans listed in the beanNames/list section are considered transactional -->
    <bean id="autoProxyCreator"
        class="org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator">
        <property name="interceptorNames">
            <list>
                <idref local="matchAllTxInterceptor" />
            </list>
        </property>
        <property name="beanNames">
            <list>
                <value>*Service</value>
                <value>genericDao</value>
            </list>
        </property>
    </bean>
    <!--  END PROPAGATION REQUIRED TX DECLARATIONS -->

    <!-- SERVICES -->

    <bean id="messagingService" class="org.kuali.rice.kcb.service.impl.MessagingServiceImpl">
        <property name="jobName"><value>${kcb.quartz.job.name}</value></property>
        <property name="jobGroup"><value>${kcb.quartz.group}</value></property>
        <property name="messageService"><ref local="messageService"/></property>
        <property name="messageDeliveryService"><ref local="messageDeliveryService"/></property>
        <property name="recipientPreferenceService"><ref local="recipientPreferenceService"/></property>
        <property name="synchronous"><value>${kcb.messaging.synchronous}</value></property>
    </bean>

    <bean id="messageService" class="org.kuali.rice.kcb.service.impl.MessageServiceImpl">
        <property name="genericDao"><ref local="genericDao"/></property>
    </bean>

    <bean id="messageDeliveryService" class="org.kuali.rice.kcb.service.impl.MessageDeliveryServiceImpl">
        <property name="genericDao"><ref local="genericDao"/></property>
        <property name="maxProcessAttempts"><value>${kcb.maxProcessAttempts}</value></property>
    </bean>

    <bean id="messageDelivererRegistryService" class="org.kuali.rice.kcb.service.impl.MessageDelivererRegistryServiceImpl"/>

    <bean id="recipientPreferenceService" class="org.kuali.rice.kcb.service.impl.RecipientPreferenceServiceImpl">
        <property name="genericDao"><ref local="genericDao"/></property>
    </bean>

    <bean id="emailService" class="org.kuali.rice.kcb.service.impl.EmailServiceImpl">
        <property name="weburl" value="${kcb.url}"/>
        <property name="smtpHost" value="${kcb.smtp.host}"/>
    </bean>
<!-- 
    <bean id="sendNotificationKewXmlService" class="org.kuali.rice.ken.service.impl.SendNotificationServiceKewXmlImpl">
      <constructor-arg><ref local="notificationService"/></constructor-arg>
    </bean>
    
    <bean id="notificationMessageDeliveryService" class="org.kuali.rice.ken.service.impl.NotificationMessageDeliveryServiceImpl">
      <constructor-arg><ref local="genericDao"/></constructor-arg>
    </bean>
    
    <bean id="notificationMessageDelivererRegistryService" class="org.kuali.rice.ken.service.impl.NotificationMessageDelivererRegistryServiceImpl" />

    <bean id="notificationEmailService" class="org.kuali.rice.ken.service.impl.NotificationEmailServiceImpl" >
       <property name="weburl"><value>${notification.basewebappurl}</value></property>
       <property name="smtpHost"><value>${emailDeliverer.smtp.host}</value></property>
    </bean>
     -->

<!--  
    <bean id="kenIntegrationService" class="org.kuali.rice.kcb.service.impl.KENIntegrationServiceAPIImpl"/>
-->
    <bean id="kenIntegrationService" class="org.kuali.rice.kcb.service.impl.KENIntegrationServiceDirectImpl">
        <property name="dataSource" ref="kcbDataSource"/>
    </bean>

    <!-- END SERVICES -->

    <!-- DAOS -->

    <bean id="genericDao" class="org.kuali.rice.core.dao.impl.GenericDaoOjb">
        <property name="jcdAlias">
            <value>kcbDataSource</value>
        </property>
    </bean>

    <!-- END DAOS -->

    <!-- Quartz jobs -->

    <bean id="messageProcessingJobDetail" class="org.springframework.scheduling.quartz.JobDetailBean">
        <property name="group" value="${kcb.quartz.group}"/>
        <property name="name" value="${kcb.quartz.job.name}"/>
        <property name="description">
            <value>
                Job that handles asynchronous delivery and dismissal of MessageDeliveries
            </value>
        </property>
        <property name="jobClass" value="org.kuali.rice.kcb.quartz.MessageProcessingJob" />
        <property name="durability" value="true"/>
        <!-- this should result in the job being run after startup if there were any pending triggers -->
        <property name="requestsRecovery" value="true"/>
        <!--
        <property name="jobListenerNames">
            <list><value>MessageDeletionListener</value></list>
        </property>
        -->
    </bean>

    <bean id="periodicMessageProcessingTrigger" class="org.springframework.scheduling.quartz.SimpleTriggerBean">
        <property name="name" value="PeriodicMessageProcessingTrigger"/>
        <property name="group" value="${kcb.quartz.group}"/>
        <property name="jobName" value="${kcb.quartz.job.name}"/>
        <property name="jobGroup" value="${kcb.quartz.group}"/>
        <property name="description">
            <value>
                Trigger that periodically runs the KCB message processing job
            </value>
        </property>
        <property name="startDelay"><value>${kcb.messageprocessing.startDelayMS}</value></property>
        <property name="repeatInterval"><value>${kcb.messageprocessing.repeatIntervalMS}</value></property>
    </bean>
<!--     
    <bean id="deliveryJobDetail" class="org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean">
        <property name="group" value="KCB-Delivery"/>
        <property name="targetObject" ref="deliveryJob" />
        <property name="targetMethod" value="run" />
        <property name="concurrent" value="false" />
        <property name="durability" value="true"/>
        <property name="stateful" value="true"/> --> <!-- not really but we only need one running at a time -->
        <!-- this should result in the job being run after startup if there were any pending triggers -->
        <!-- 
        <property name="requestsRecovery" value="true"/>
    </bean>
     -->
    <!--
    <bean id="deliveryJob" class="org.kuali.rice.kcb.quartz.DeliveryJob">
    </bean>
     -->

    <!-- export our KCB service -->

    <bean class="org.kuali.rice.ksb.messaging.KSBExporter">
        <property name="serviceDefinition">
            <bean class="org.kuali.rice.ksb.messaging.JavaServiceDefinition">
                <property name="priority" value="1"/>
                <property name="serviceInterface"><value>org.kuali.rice.kcb.service.MessagingService</value></property>
                <property name="service"><ref bean="messagingService" /></property>
                <property name="localServiceName" value="KCB-MessagingService" />
                <!--
                <property name="serviceNameSpaceURI" value="KCB"/>
                 -->
                <property name="busSecurity" value="false"/>
            </bean>
        </property>
    </bean>
    <!--
    <bean class="org.kuali.rice.ksb.messaging.KSBExporter">
        <property name="serviceDefinition">
            <bean class="org.kuali.rice.ksb.messaging.SOAPServiceDefinition">
                <property name="service">
                    <ref bean="sendNotificationKewXmlService" />
                </property>
                <property name="localServiceName" value="sendNotificationKewXmlSOAPService" />
                <property name="priority" value="10" />
                <property name="retryAttempts" value="1" />
            </bean>
        </property>
         -->
        <!-- THIS IS NEEDED FOR THE KEWINTEGRATIONTEST TO OBSERVE THE SERVICE ON THE BUS... -->
        <!-- 
        <property name="forceRefresh" value="true"/>
    </bean>
    -->
 
    <bean class="org.kuali.rice.ksb.messaging.KSBExporter">
        <property name="serviceDefinition">
            <bean class="org.kuali.rice.ksb.messaging.JavaServiceDefinition">
                <property name="priority" value="1"/>
                <property name="serviceInterface"><value>org.kuali.rice.kcb.service.MessageDelivererRegistryAPI</value></property>
                <property name="service"><ref bean="messageDelivererRegistryService" /></property>
                <property name="localServiceName" value="KCB-MessageDelivererRegistryAPI" />
                <!--
                <property name="serviceNameSpaceURI" value="KCB"/>
                 -->
                <property name="busSecurity" value="false"/>
            </bean>
        </property>
    </bean>
    <!--
    <bean class="org.kuali.rice.ksb.messaging.KSBExporter">
        <property name="serviceDefinition">
            <bean class="org.kuali.rice.ksb.messaging.SOAPServiceDefinition">
                <property name="service">
                    <ref bean="sendNotificationKewXmlService" />
                </property>
                <property name="localServiceName" value="sendNotificationKewXmlSOAPService" />
                <property name="priority" value="10" />
                <property name="retryAttempts" value="1" />
            </bean>
        </property>
         -->
        <!-- THIS IS NEEDED FOR THE KEWINTEGRATIONTEST TO OBSERVE THE SERVICE ON THE BUS... -->
        <!-- 
        <property name="forceRefresh" value="true"/>
    </bean>
    -->
</beans>